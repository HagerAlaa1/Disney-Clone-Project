!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).VISION=t()}(this,(function(){"use strict";const e=()=>`${Date.now()}-${Math.floor(1e13*Math.random())}`,t=(e,t)=>{const s=e.concat(t),i=s.length;let n=[7,11],r=[71,173];const a=[2277735313,289559509],o=[1291169091,658871167];for(let e=0;e<i;e++)n=[(n[0]<<5)-n[0]+s.charCodeAt(e),(n[1]<<3)-n[1]+s.charCodeAt(e)],r=[(r[0]<<4)-r[0]+s.charCodeAt(e),(r[1]<<6)-r[1]+s.charCodeAt(e)],n=[n[0]^a[0],n[1]^a[1]],r=[r[0]^o[0],r[1]^o[1]];return`00000000${(n[0]>>>0).toString(16)}`.slice(-8)+`00000000${(n[1]>>>0).toString(16)}`.slice(-8)+`00000000${(r[0]>>>0).toString(16)}`.slice(-8)+`00000000${(r[1]>>>0).toString(16)}`.slice(-8)},s=(e,t)=>!!t&&t.split(",").reduce(((e,t)=>((t=t.replace(/\(.*\)/g,"").trim())&&e.push(t),e)),[]).indexOf(e.replace(/\(.*\)/g,"").trim())>-1,i=e=>{const t=new ArrayBuffer(e.length),s=new Uint8Array(t);for(let t=0,i=e.length;t<i;t++)s[t]=e.charCodeAt(t);return t};class n{constructor(e,t){this.callback=e,this.adCount=1,this.adStartTime=0,this.adTimeSpent=0,this.previousAdTimeSpent=0,this.previousTimeSpent=0,this.startTime=0,this.timeSpent=0,t.subscribe((()=>this.config=t.getState())),this.config=t.getState()}createMediaSession(t){this.sessionId||(t.event_name=t.event_name.replace("_play","_start"),this.sessionId=e(),this.dispatch(Object.assign(Object.assign({},t),{event_name:"media_init"})))}dispatch(e,t=!1,s){let i=(t&&s?s:this.adTimeSpent)/1e3||0,n=(!t&&s?s:this.timeSpent)/1e3||0;const r=Date.now();if(t&&Math.abs(this.previousAdTimeSpent-i)>this.config.mediaAdHeartbeatSec+1)i=this.previousAdTimeSpent+this.config.mediaAdHeartbeatSec,this.adTimeSpent=1e3*i,this.adStartTime=r;else if(!t){const t=this.getHeartbeatInterval(e);Math.abs(this.previousTimeSpent-n)>t+1&&(n=this.previousTimeSpent+t,this.timeSpent=1e3*n,this.startTime=r)}this.previousAdTimeSpent=i,this.previousTimeSpent=n,this.callback(Object.assign(Object.assign({},e),{event_timestamp:r,media_ad_time_spent:i,media_session_id:this.sessionId,media_time_spent:n}))}dispatchMediaAdStop(e){const t=JSON.parse(e);t.event_name="media_ad_stop",this.dispatch(t,!0),this.adTimeSpent=0,this.previousAdTimeSpent=0,this.timeSpent=0,this.previousTimeSpent=0,this.adStartTime=0,this.sessionId=void 0}dispatchMediaStop(e){const t=JSON.parse(e);t.event_name="media_stop",this.adCount=1,this.dispatch(t),this.adTimeSpent=0,this.previousAdTimeSpent=0,this.timeSpent=0,this.previousTimeSpent=0,this.startTime=0,this.adStartTime=0,this.sessionId=void 0}getHeartbeatInterval({media_content_length:e}){return(null!=e?e:1/0)<this.config.mediaLengthShortSec?this.config.mediaHeartbeatShortSec:(null!=e?e:1/0)<this.config.mediaLengthMediumSec?this.config.mediaHeartbeatMediumSec:this.config.mediaHeartbeatLongSec}handleEvent(e){const t=Date.now();switch(e.event_name){case"media_ad_pause":if(!this.sessionId)return;window.clearInterval(this.adHeartbeatIntervalId),this.setAdPauseTimeout(e),this.adTimeSpent+=t-this.adStartTime,this.adStartTime=0,this.dispatch(e,!0);break;case"media_ad_play":window.clearTimeout(this.adPauseTimeoutId),this.createMediaSession(e),this.setAdHeartbeatInterval(e),this.adStartTime=t,this.dispatch(e,!0);break;case"media_ad_skipped":if(!this.sessionId)return;window.clearInterval(this.adHeartbeatIntervalId),window.clearTimeout(this.adPauseTimeoutId),this.timeSpent>0&&(this.setHeartbeatInterval(e),this.startTime=t),this.adCount+=1,this.adStartTime>0&&(this.adTimeSpent+=t-this.adStartTime),this.dispatch(e,!0),this.dispatch(Object.assign(Object.assign({},e),{event_name:"media_ad_stop"}),!0),this.adStartTime=0;break;case"media_ad_start":this.createMediaSession(e),this.setAdHeartbeatInterval(e),this.startTime>0&&(window.clearInterval(this.heartbeatIntervalId),this.timeSpent+=t-this.startTime,this.startTime=0),this.adStartTime=t,this.dispatch(e,!0);break;case"media_ad_stop":if(!this.sessionId)return;window.clearInterval(this.adHeartbeatIntervalId),window.clearTimeout(this.adPauseTimeoutId),this.timeSpent>0&&(this.setHeartbeatInterval(e),this.startTime=t),this.adCount+=1,this.adStartTime>0&&(this.adTimeSpent+=t-this.adStartTime),this.dispatch(e,!0),this.adStartTime=0;break;case"media_backward":if(!this.sessionId||0===this.startTime)return;this.timeSpent+=t-this.startTime,this.startTime=t,this.dispatch(e);break;case"media_buffer_end":case"media_buffer_start":case"media_forward":if(!this.sessionId)return;this.timeSpent+=t-this.startTime,this.startTime=t,this.dispatch(e);break;case"media_dispose_ad_stop":if(window.clearInterval(this.adHeartbeatIntervalId),window.clearInterval(this.heartbeatIntervalId),window.clearTimeout(this.adPauseTimeoutId),0===this.adStartTime)return;e.event_name="media_ad_stop",this.adCount+=1,this.adTimeSpent+=t-this.adStartTime,this.dispatch(e,!0),this.adTimeSpent=0,this.previousAdTimeSpent=0,this.timeSpent=0,this.previousTimeSpent=0,this.startTime=0,this.sessionId=void 0;break;case"media_pause":if(!this.sessionId||0===this.startTime)return;window.clearInterval(this.heartbeatIntervalId),this.setPauseTimeout(e),this.timeSpent+=t-this.startTime,this.startTime=0,this.dispatch(e);break;case"media_play":window.clearTimeout(this.pauseTimeoutId),this.createMediaSession(e),this.setHeartbeatInterval(e),this.startTime=t,this.dispatch(e);break;case"media_start":this.createMediaSession(e),this.setHeartbeatInterval(e),this.startTime=t,this.dispatch(e);break;case"media_stop":if(window.clearInterval(this.heartbeatIntervalId),window.clearTimeout(this.pauseTimeoutId),!this.sessionId)return;this.startTime>0&&(this.timeSpent+=t-this.startTime),this.adCount=1,this.dispatch(e),this.adTimeSpent=0,this.previousAdTimeSpent=0,this.timeSpent=0,this.previousTimeSpent=0,this.startTime=0,this.sessionId=void 0}}setAdHeartbeatInterval(e){window.clearInterval(this.adHeartbeatIntervalId);const t=JSON.stringify(e);this.adHeartbeatIntervalId=window.setInterval((()=>{const e=JSON.parse(t),s=Date.now()-this.adStartTime+this.adTimeSpent;e.event_name="media_ad_heartbeat",e.media_current_position=void 0,s>12e4*this.adCount?(window.clearInterval(this.adHeartbeatIntervalId),this.adTimeSpent=s,this.dispatchMediaAdStop(t)):this.dispatch(e,!0,s)}),1e3*this.config.mediaAdHeartbeatSec)}setAdPauseTimeout(e){window.clearTimeout(this.adPauseTimeoutId),this.adPauseTimeoutId=window.setTimeout((()=>this.dispatchMediaAdStop(JSON.stringify(e))),1e3*this.config.mediaPauseTimeoutSec)}setHeartbeatInterval(e){window.clearInterval(this.heartbeatIntervalId);const t=JSON.stringify(e);this.heartbeatIntervalId=window.setInterval((()=>{const e=JSON.parse(t),s=Date.now()-this.startTime+this.timeSpent;e.event_name="media_heartbeat",e.media_current_position=void 0,e.media_content_length&&s>2*e.media_content_length*1e3?(window.clearInterval(this.heartbeatIntervalId),this.timeSpent=s,this.dispatchMediaStop(t)):this.dispatch(e,!1,s)}),1e3*this.getHeartbeatInterval(e))}setPauseTimeout(e){window.clearTimeout(this.pauseTimeoutId),this.pauseTimeoutId=window.setTimeout((()=>this.dispatchMediaStop(JSON.stringify(e))),1e3*this.config.mediaPauseTimeoutSec)}}const r=e=>a(e)&&"event_name"in e,a=e=>"object"==typeof e&&null!=e&&!Array.isArray(e),o=e=>!isNaN(e)&&e instanceof Date,c="Collection-Status",d={ad_id:"ad1",ad_creative:"ad2",ad_type:"ad3",ad_placement:"ad4",ad_orientation:"ad6",ad_destination_url:"ad7",ad_version:"ad8",ad_parent_type:"ad9",ad_parent_id:"ad10",ad_pod_number:"ad11",ad_pod_size:"ad12",api_url:"ap1",api_method:"ap2",api_response_time:"ap3",article_id:"ar1",article_id_source:"ar2",article_name:"ar3",event_name:"e2",event_instance_id:["e3",!0],event_session_sequence_num:["e4",!0],event_timestamp:"e6",event_log_timestamp:["e7",!0],event_test:"e10",funnel_type:"fn1",funnel_name:"fn2",funnel_milestone:"fn3",impression_id:"imp1",impression_id_source:"imp2",impression_type:"imp3",link_module_name:"l1",link_module_position:"l2",link_name:"l4",link_position:"l5",link_destination_location:"l7",link_destination_url:"l8",media_id:"m1",media_id_source:"m2",media_name:"m3",media_observed_bitrate:"m5",media_content_length:"m6",media_current_position:"m7",media_current_chapter:"m8",media_player_name:"m9",media_player_type:"m10",media_player_version:"m11",media_session_id:"m12",media_subtitle_language:"m16",media_video_type:"m20",media_ad_id:"m26",media_ad_id_source:"m27",media_time_spent:"m28",media_ad_time_spent:"m29",media_live:"m30",media_viewing_mode:"m31",media_channel:"m32",media_air_date:"m33",media_air_time:"m34",media_airing_id:"m35",media_program_code:"m36",media_segment:"m37",media_start_type:"m40",media_network_name:"m41",media_is_mute:"m42",media_live_scoring:"m43",media_autoplay_sound:"m45",media_video_type_detail:"m46",media_show_code:"m47",media_play_location:"m48",media_binge_play_count:"m53",page_location:["p1",!1,!0],page_url:["p2",!1,!0],page_id:["p3",!1,!0],page_id_source:["p4",!1,!0],page_instance_id:["p5",!1,!0],page_previous_url:["p6",!0,!0],page_z_axis:"p7",page_version:"p8",page_type:["p9",!1,!0],page_time_spent:"p10",page_user_mode:"p11",page_auth_flag:"p12",page_nav_method:"p13",page_premium_content:"p14",pzncon_event:"pc1",pzncon_personalized:"pc2",pzncon_curated:"pc3",pzncon_reason:"pc4",pzncon_rule:"pc5",pzncon_edition:"pc6",pzncon_slot_position:"pc7",pzncon_presentation_type:"pc8",pzncon_content_id:"pc9",pzncon_content_id_type:"pc10",pzncon_nav_method:"pc11",pzncon_clubhouse:"pc12",pzncon_feed_version:"pc13",pzncon_content_score:"pc14",pzncon_entitled:"pc15",pzncon_collection_id:"pc16",pzncon_collection_id_type:"pc17",pzncon_personal_metadata:"pc18",pzncon_originally_published:"pc19",pzncon_last_modified:"pc20",pzncon_content_title:"pc21",pzncon_personal_metadata_ids:"pc22",pzncon_premium:"pc23",pzncol_collection_id:"pcl1",pzncol_collection_id_type:"pcl2",pzncol_content_id:"pcl3",pznfav_event:"pf1",pznfav_entity_id:"pf2",pznfav_entity_type:"pf3",state_cmp:["s1",!1,!0],state_test:["s2",!1,!0],state_orientation:["s3",!0],session_id:["se1",!0],session_language:["se2",!0],session_first_page:["se3",!0],session_first_url:["se4",!0],session_first_referrer_url:["se5",!0],session_start_timestamp:["se9",!0],session_total_time:["se10",!0],search_module:"sr1",search_type:"sr2",search_keyword_executed:"sr3",search_keyword_typed:"sr4",search_refinement:"sr5",search_results_count:"sr6"},l={app_bundle_id:["a1",!0],app_suite:["a2",!0],app_platform:["a3",!0],app_version:["a4",!0],app_logging_lib_version:["a5",!0],app_region:["a6",!0],app_country:["a7",!0],app_network:["a8",!0],app_zipcode:["a10",!0],app_id:["a11",!0],browser_height:["br2",!0],browser_width:["br3",!0],browser_cookies_flag:["br4",!0],browser_local_storage_flag:["br5",!0],browser_java_flag:["br6",!0],browser_plugins:["br8",!0],browser_flash_version:["br9",!0],device_height:["d5",!0],device_width:["d6",!0],device_advertiser_id:["d13",!0,!0],user_guest_id:["u1",!0],user_affiliate:["u2",!0,!0],user_mvpd_short_name:["u3",!0,!0],user_mvpd_name:["u4",!0,!0],user_subscriber_type:["u5",!0,!0],user_access_method:["u6",!0,!0],user_disney_plus_bundle:["u7",!0,!0],user_anonymous_id:["u8",!0],user_subscription_id:["u9",!0,!0],user_dss_id:["u10",!0,!0]},h=[{name:"app_country"},{name:"app_region"},{name:"app_zipcode"},{name:"device_advertiser_id"},{name:"session_language"},{name:"user_affiliate"},{name:"user_anonymous_id"},{name:"user_dss_id"},{name:"user_guest_id"},{name:"user_subscription_id",properties:["id"]}],u={collection:!0,compression:"none",customLoggerApiEndpoint:"",disableAppVersions:"",disableMediaAppVersions:"",disableMediaSdkVersions:"",disableSdkVersions:"",flushAtEventCount:10,flushIntervalSec:60,mediaAdHeartbeatSec:5,mediaCollection:!0,mediaHeartbeatLongSec:20,mediaHeartbeatMediumSec:10,mediaHeartbeatShortSec:5,mediaLengthMediumSec:3600,mediaLengthShortSec:90,mediaPauseTimeoutSec:600,pageActiveThreshold:120,pageHeartbeatCollection:!1,pageHeartbeatInSeconds:60,pollConfigIntervalSec:600,privacy:!1,privacyProperties:h,useCustomLoggerApi:!1},p="13.2.0",_="vision",m="vision";class v{constructor(){this.events={}}publish(e,...t){var s;null===(s=this.events[e])||void 0===s||s.forEach((e=>e(...t)))}subscribe(e,t){Array.isArray(this.events[e])||(this.events[e]=[]),this.events[e].push(t);const s=this.events[e].length-1;return()=>this.events[e].splice(s,1)}}class g{constructor(e){this.store=e}log(e,t="Debug"){this.store.getState().debugMode&&console.log(`VISION Log (${t}):`,e)}}class f{constructor(e,t,s,i){this.eventBus=e,this.storage=t,this.store=s,this.lastEvent=0,e.subscribe("client.unset-force-disable-collection",(()=>this.create())),i.subscribe((()=>{this.config=i.getState();const{pageHeartbeatInSeconds:e}=this;this.pageHeartbeatInSeconds=this.config.pageHeartbeatInSeconds,null!=this.heartbeatIntervalId&&e!==this.pageHeartbeatInSeconds&&this.setHeartbeatInterval()})),this.config=i.getState(),this.pageHeartbeatInSeconds=this.config.pageHeartbeatInSeconds}create(){const t=Date.now(),s={active:t+18e5,event_session_sequence_num:0,expires:t+432e5,session_id:e(),session_start_timestamp:t,session_total_time:0,vision_id:e()};return this.storage.setLocalItem("visionSession",s),s}createAnonId(){const t={expires:Date.now()+33927469800,user_anonymous_id:e()};return this.storage.setLocalItem("visionAnonId",t),t}extend(){const e=this.readOrCreate(),t=Date.now();e.expires-t>0&&e.active-t>0?this.storage.setLocalItem("visionSession",Object.assign(Object.assign({},e),{active:t+18e5})):this.create()}readOrCreate(){const e=this.storage.getLocalItem("visionSession");return null!=e?e:this.create()}readOrCreateAnonId(){const e=this.storage.getLocalItem("visionAnonId");return null!=e&&e.expires-Date.now()>0?e:this.createAnonId()}run(){this.eventBus.subscribe("tracking.activity",(()=>{this.extend(),this.touchLastEvent()})),this.eventBus.subscribe("tracking.page",(e=>this.updatePageProperties(e))),window.addEventListener("pagehide",(()=>this.updateTimeSpent())),window.document.addEventListener("scroll",(()=>this.touchLastEvent())),this.setHeartbeatInterval(),this.readOrCreateAnonId(),this.extend(),this.touchLastEvent(),this.store.setState({lastHeartbeat:Date.now()})}setHeartbeatInterval(){window.clearInterval(this.heartbeatIntervalId),this.heartbeatIntervalId=window.setInterval((()=>{this.updateTimeSpent((()=>{Date.now()-this.lastEvent<1e3*this.config.pageActiveThreshold?this.config.pageHeartbeatCollection&&this.eventBus.publish("session.page-heartbeat"):(this.eventBus.publish("session.page-close"),this.lastEvent=0)}))}),1e3*this.config.pageHeartbeatInSeconds)}touchLastEvent(){this.lastEvent=Date.now()}update(e){const t=this.readOrCreate(),s=Object.keys(e).reduce(((s,i)=>{const n=e[i];return s[i]="function"==typeof n?n(t[i]):n,s}),{});this.storage.setLocalItem("visionSession",Object.assign(Object.assign({},t),s))}updatePageProperties(e){const t=this.storage.getLocalItem("visionSession"),s={};if(!(null==t?void 0:t.session_first_referrer_url)){const e=this.storage.getSessionItem("visionPagePreviousUrl");e&&(s.session_first_referrer_url=e)}if(e.page_location&&!(null==t?void 0:t.session_first_page)&&(s.session_first_page=e.page_location),e.page_url&&!(null==t?void 0:t.session_first_url)&&(s.session_first_url=e.page_url),Object.keys(s).length&&this.update(s),"page_view"===e.event_name&&e.page_url){const e=this.storage.getSessionItem("visionPageUrl");e&&this.storage.setSessionItem("visionPagePreviousUrl",e)}}updateTimeSpent(e){const t=Date.now(),s=t-this.store.getState().lastHeartbeat;this.lastEvent>0&&s>0&&s<=1.1*this.config.pageHeartbeatInSeconds*1e3&&(null==e||e(),this.update({session_total_time:e=>e+s/1e3})),this.store.setState({lastHeartbeat:t})}}class S{constructor(){this.memo={},this.getLocalItem=S.createGetter("localStorage"),this.getSessionItem=S.createGetter("sessionStorage"),this.removeLocalItem=S.createRemover("localStorage"),this.removeSessionItem=S.createRemover("sessionStorage"),this.setLocalItem=S.createSetter("localStorage"),this.setSessionItem=S.createSetter("sessionStorage")}static createGetter(e){return function(t){if(!this.isAvailable(e))return null;try{return JSON.parse(window[e].getItem(t))}catch(e){}return null}}static createRemover(e){return function(t){this.isAvailable(e)&&window[e].removeItem(t)}}static createSetter(e){return function(t,s){if(!this.isAvailable(e))return;const i=JSON.stringify(s);void 0!==i&&window[e].setItem(t,i)}}isAvailable(e){if(null==this.memo[e])try{const t=window[e],s="__storage_test__";t.setItem(s,s),t.removeItem(s),this.memo[e]=!0}catch(t){this.memo[e]=!1}return this.memo[e]}}const b=e=>{let t;const s=new Set,i=(e,i)=>{const n="function"==typeof e?e(t):e;if(!Object.is(n,t)){const e=t;t=(null!=i?i:"object"!=typeof n||null===n)?n:Object.assign({},t,n),s.forEach((s=>s(t,e)))}},n=()=>t,r={setState:i,getState:n,getInitialState:()=>a,subscribe:e=>(s.add(e),()=>s.delete(e))},a=t=e(i,n,r);return r},w=e=>e?b(e):b;const I=()=>{const e=window.navigator.plugins["Shockwave Flash 2.0"]||window.navigator.plugins["Shockwave Flash"],t=window.navigator.userAgent.toLowerCase();return`flash_version:${e?(e=>{const t=e.description.split(" "),[s,i]=t[2].split("."),n=""!==t[3]?t[3]:t[4];return[s,i,"d"===n[0]?n.slice(1):"r"===n[0]?n.replace(/^r(.?[^d]*).*/,"$1"):n].join(".")})(e):t.indexOf("webtv/2.6")>-1?"4":t.indexOf("webtv/2.5")>-1?"3":t.indexOf("webtv")>-1?"2":y()?(()=>{try{return new window.ActiveXObject("ShockwaveFlash.ShockwaveFlash.7").GetVariable("$version")}catch(e){}try{const e=new window.ActiveXObject("ShockwaveFlash.ShockwaveFlash.6");return e.AllowScriptAccess="always",e.GetVariable("$version")}catch(e){}try{return new window.ActiveXObject("ShockwaveFlash.ShockwaveFlash.6"),"WIN 6,0,21,0"}catch(e){}try{return new window.ActiveXObject("ShockwaveFlash.ShockwaveFlash.3").GetVariable("$version")}catch(e){}try{return new window.ActiveXObject("ShockwaveFlash.ShockwaveFlash.3"),"WIN 3,0,18,0"}catch(e){}try{return new window.ActiveXObject("ShockwaveFlash.ShockwaveFlash"),"WIN 2,0,0,11"}catch(e){}return"-1"})():"-1"}`},y=()=>window.navigator.appVersion.indexOf("MSIE")>-1&&window.navigator.appVersion.toLowerCase().indexOf("win")>-1&&-1===window.navigator.userAgent.indexOf("Opera");class T{constructor(e,t,s){this.storage=e,this.store=t,s.subscribe((()=>this.config=s.getState())),this.config=s.getState()}app_bundle_id(){return this.store.getState().app_bundle_id}app_country(){return this.store.getState().app_country}app_id(){return this.store.getState().app_id}app_logging_lib_version(){return p}app_network(){return this.store.getState().app_network}app_platform(){return this.store.getState().app_platform}app_region(){return this.store.getState().app_region}app_suite(){return this.store.getState().app_suite}app_version(){return this.store.getState().app_version}app_zipcode(){return this.store.getState().app_zipcode}browser_cookies_flag(){return window.navigator.cookieEnabled}browser_flash_version(){return I()}browser_height(){return Math.floor(window.innerHeight||window.document.body.clientHeight)}browser_local_storage_flag(){return this.storage.isAvailable("localStorage")}browser_java_flag(){return"function"==typeof window.navigator.javaEnabled&&window.navigator.javaEnabled()}browser_plugins(){var e;if(null!=(null===(e=window.navigator.plugins)||void 0===e?void 0:e.length))return Array.prototype.map.call(window.navigator.plugins,(e=>e.name)).join(";")}browser_width(){return Math.floor(window.innerWidth||window.document.body.clientWidth)}device_height(){return Math.floor(window.screen.height)}device_width(){return Math.floor(window.screen.width)}event_instance_id(){return e()}event_log_timestamp(){return Date.now()}event_session_sequence_num(){const e=this.storage.getLocalItem("visionSession");if(null!=e)return e.event_session_sequence_num+=1,this.storage.setLocalItem("visionSession",e),e.event_session_sequence_num}event_timestamp(e){return(null==e?void 0:e.event_timestamp)||Date.now()}pzncon_last_modified(e){const t=new Date(null==e?void 0:e.pzncon_last_modified);return o(t)?t.getTime():void 0}pzncon_originally_published(e){const t=new Date(null==e?void 0:e.pzncon_originally_published);return o(t)?t.getTime():void 0}session_first_page(){var e;return null===(e=this.storage.getLocalItem("visionSession"))||void 0===e?void 0:e.session_first_page}session_first_referrer_url(){var e;return null===(e=this.storage.getLocalItem("visionSession"))||void 0===e?void 0:e.session_first_referrer_url}session_first_url(){var e;return null===(e=this.storage.getLocalItem("visionSession"))||void 0===e?void 0:e.session_first_url}session_id(){var e;return null===(e=this.storage.getLocalItem("visionSession"))||void 0===e?void 0:e.session_id}session_language(){return window.navigator.language||window.navigator.browserLanguage}session_start_timestamp(){var e;return null===(e=this.storage.getLocalItem("visionSession"))||void 0===e?void 0:e.session_start_timestamp}session_total_time(){var e;const t=Date.now()-this.store.getState().lastHeartbeat,s=t>0&&t<=1.1*this.config.pageHeartbeatInSeconds*1e3,i=(null===(e=this.storage.getLocalItem("visionSession"))||void 0===e?void 0:e.session_total_time)||0;return s?i+t/1e3:i}state_cmp(e){return(null==e?void 0:e.state_cmp)||(t="cmp",window.document.location.search.slice(1).split("&").reduce(((e,s)=>{const[i,n]=s.split("=");return null!=e||i!==t?e:null==n?"":decodeURIComponent(n)}),void 0));var t}state_orientation(){return window.matchMedia("(orientation: landscape)").matches?"landscape":"portrait"}user_anonymous_id(){var e;return null===(e=this.storage.getLocalItem("visionAnonId"))||void 0===e?void 0:e.user_anonymous_id}user_guest_id(){return this.store.getState().guestIds.map((e=>Object.assign({},e)))}}class A{constructor(e,t,s,i,n){this.eventBus=e,this.storage=t,this.store=s,this.xhr=i,n.subscribe((()=>{this.config=n.getState();const{flushIntervalSec:e}=this;this.flushIntervalSec=this.config.flushIntervalSec,null!=this.flushIntervalId&&e!==this.flushIntervalSec&&this.setFlushInterval()})),this.config=n.getState(),this.flushIntervalSec=this.config.flushIntervalSec,this.trackingModel=new T(t,s,n)}anonymize(e){const t=this.isValidPrivacyProperties(this.config.privacyProperties)?this.config.privacyProperties:h;function s(e,t){a(e)&&t.forEach((t=>delete e[t]))}function i(e){t.forEach((({name:t,properties:i})=>{const n=e[t];void 0!==n&&(Array.isArray(i)?Array.isArray(n)?n.forEach((e=>s(e,i))):s(n,i):void 0===i&&delete e[t])}))}i(e.global),e.events.forEach((e=>{i(e),e.state_privacy=!0}))}batchEvents(e){(e=[...(this.storage.getLocalItem("visionEvents")||[]).filter(this.isEventData),...e]).length>=this.config.flushAtEventCount?(this.xhr.postEvents(this.createPayload(e)),this.storage.removeLocalItem("visionEvents")):this.storage.setLocalItem("visionEvents",e)}createEventData(e){const t=this.storage.getSessionItem("visionCustomEventProperties");return e.map((e=>this.mapProperties(d,Object.assign(Object.assign({},e),t))))}createPayload(e){const t=this.storage.getSessionItem("visionCustomGlobalProperties"),s={events:e,global:this.mapProperties(l,t)};return(this.config.privacy||this.storage.getSessionItem("visionStatePrivacy"))&&!this.store.getState().skipPrivacyValidation&&this.anonymize(s),s}handleEvents(e){if(this.isCollectionDisabled())return;const{flatPayload:t}=this.store.getState(),{eventsToBatch:s,eventsToPost:i,isActivity:n}=e.reduce(((e,s)=>{if(s.event_name.startsWith("media_"))return e;this.eventBus.publish("tracking.page",s);const i="pzncon"!==s.event_name||t?"eventsToPost":"eventsToBatch";return e.isActivity=e.isActivity||-1===["page_close","page_heartbeat"].indexOf(s.event_name),e[i].push(s),e}),{eventsToBatch:[],eventsToPost:[],isActivity:!1});if(n&&this.eventBus.publish("tracking.activity"),s.length&&this.batchEvents(this.createEventData(s)),i.length){const{events:e,global:s}=this.createPayload(this.createEventData(i));t?e.forEach((e=>this.xhr.postEvents({events:[e],global:s}))):this.xhr.postEvents({events:e,global:s})}}isCollectionDisabled(){return!this.config.collection||s(p,this.config.disableSdkVersions)||s(this.store.getState().app_version,this.config.disableAppVersions)||!!this.storage.getLocalItem("visionForceDisableCollection")}isEventData(e){return a(e)&&"event_name"in e}isMediaCollectionDisabled(){return!this.config.mediaCollection||s(p,this.config.disableMediaSdkVersions)||s(this.store.getState().app_version,this.config.disableMediaAppVersions)||this.isCollectionDisabled()}isValidPrivacyProperties(e){return Array.isArray(e)&&!!e.length&&e.every((e=>a(e)&&"name"in e))}mapProperties(e,t){const s=t?Object.keys(t):[],i=[...new Set([...Object.keys(e),...s])],n=e=>this.store.getState().removeEmptyValues?(e=>null==e||""===e||"null"===e||"undefined"===e||"object"==typeof e&&0===Object.keys(e).length)(e):void 0===e;return i.reduce(((s,i)=>{var a;const o=e[i],[,c,d]=Array.isArray(o)?o:[o,!1];let l=c||null==t?void 0:t[i];if("function"==typeof this.trackingModel[i]&&(l=this.trackingModel[i](r(t)?t:void 0)),d){const e=`vision${(e=>e.split("_").map((e=>e.charAt(0).toUpperCase()+e.slice(1))).join(""))(i)}`;n(l)?l=null!==(a=this.storage.getSessionItem(e))&&void 0!==a?a:void 0:this.storage.setSessionItem(e,l)}return n(l)||(s[i]=l),s}),{})}postBatch(){const e=(this.storage.getLocalItem("visionEvents")||[]).filter(this.isEventData);!e.length||this.store.getState().flatPayload||this.isCollectionDisabled()||(this.xhr.postEvents(this.createPayload(e)),this.storage.removeLocalItem("visionEvents"))}postMedia(e){this.isMediaCollectionDisabled()||(this.eventBus.publish("tracking.page",e),this.eventBus.publish("tracking.activity"),this.xhr.postEvents(this.createPayload(this.createEventData([e])),!0))}run(){this.eventBus.subscribe("session.page-close",(()=>this.handleEvents([{event_name:"page_close"}]))),this.eventBus.subscribe("session.page-heartbeat",(()=>this.handleEvents([{event_name:"page_heartbeat"}]))),this.setFlushInterval()}setFlushInterval(){window.clearInterval(this.flushIntervalId),this.flushIntervalId=window.setInterval((()=>this.postBatch()),1e3*this.flushIntervalSec)}}const C=new S;class k{constructor(e,t){if(this._activated=!1,this._fetchIntervalSec=600,this._fetchTimestamp=-1,this._lastFetchStatus="no-fetch-yet","object"!=typeof e||null==e)throw new TypeError("VISION Configurator: default config argument is invalid");if("object"!=typeof t&&null!=t)throw new TypeError("VISION Configurator: settings argument is invalid");const{fetchIntervalSec:s,sdk:i,url:n}=null!=t?t:{};this._settings={debug:!!(null==t?void 0:t.debug),sdk:"",url:""},this._store=w((()=>e)),"number"==typeof s&&(this._fetchIntervalSec=s>60?s:60),"string"==typeof i&&(this._settings.sdk=i),"string"==typeof n&&/^https?:\/\//.test(n)&&(this._settings.url=n),this._promise=new Promise((e=>this._resolve=e)).then((()=>{this._activated=!0}))}get activated(){return this._activated}get defaultConfig(){return this._store.getInitialState()}async ensureActivated(){await this._promise}async fetchConfig(){var e;if(null!=this._fetchIntervalId)return;if(!this._validates())return void console.error(new Error("VISION Configurator: settings are invalid"));this._store.subscribe((e=>{const{_fetchIntervalSec:t}=this,s="pollConfigIntervalSec"in e?e.pollConfigIntervalSec:void 0;"number"==typeof s&&(this._fetchIntervalSec=s>60?s:60),null!=this._fetchIntervalId&&t!==this._fetchIntervalSec&&this._setFetchInterval()}));const t=C.getLocalItem(`${this._settings.sdk}ConfigTimestamp`);if("number"==typeof t&&(Date.now()-t)/1e3<this._fetchIntervalSec){const t=C.getLocalItem(`${this._settings.sdk}Configuration`)||{};this._store.setState(Object.assign(Object.assign({},this._store.getInitialState()),t),!0),null===(e=this._resolve)||void 0===e||e.call(this)}else await this._fetchRemote();this._setFetchInterval()}async _fetchRemote(e=!0){var s,i,n;if(!C.getLocalItem("visionForceDisableCollection"))if(this._validates())try{let e;if(this._settings.url.startsWith("https://vision.fn-pz")){const i=(null===(s=C.getLocalItem("visionSession"))||void 0===s?void 0:s.session_id)||"";e={credentials:"include",headers:{Authorization:t(i,m),"Session-Id":i}}}const r=await window.fetch(this._settings.url,e),a=r.ok?null===(i=await r.json())||void 0===i?void 0:i.config:void 0;if(!r.ok)throw new Error(await r.text());if("object"!=typeof a||null==a)throw new TypeError("config is invalid");this._lastFetchStatus="success",this._fetchTimestamp=Date.now(),C.setLocalItem(`${this._settings.sdk}ConfigTimestamp`,this._fetchTimestamp),C.setLocalItem(`${this._settings.sdk}Configuration`,a),this._store.setState(Object.assign(Object.assign({},this._store.getInitialState()),a),!0),this._activated||null===(n=this._resolve)||void 0===n||n.call(this),this._settings.debug&&console.log("VISION Configurator:",a)}catch(t){if(e)return void await this._fetchRemote(!1);this._lastFetchStatus="failure",this._settings.debug&&console.log("VISION Configurator:",t)}else console.error(new Error("VISION Configurator: settings are invalid"))}get fetchTimestamp(){return this._fetchTimestamp}getAll(){return this._store.getState()}getValue(e){return this._store.getState()[e]}get lastFetchStatus(){return this._lastFetchStatus}_setFetchInterval(){window.clearInterval(this._fetchIntervalId),this._fetchIntervalId=window.setInterval((()=>this._fetchRemote()),1e3*this._fetchIntervalSec)}get settings(){return this._settings}get store(){return this._store}subscribe(e){return this._store.subscribe(e)}_validates(){const{sdk:e,url:t}=this._settings;return"string"==typeof e&&!!e&&"string"==typeof t&&/^https?:\/\//.test(t)}}"function"==typeof SuppressedError&&SuppressedError;var O,E={},H={};function P(){if(O)return H;O=1;var e=[0,255,65535,16777215,4294967295];function t(e,t,s,i,n){var r;for(r=0;r<n;r++)s[i+r]=e[t+r]}function s(e,t,s,i){var n;for(n=0;n<i;n++)e[t+n]=e[t-s+n]}function i(e){this.array=e,this.pos=0}return i.prototype.readUncompressedLength=function(){for(var e,t,s=0,i=0;i<32&&this.pos<this.array.length;){if(e=this.array[this.pos],this.pos+=1,(t=127&e)<<i>>>i!==t)return-1;if(s|=t<<i,e<128)return s;i+=7}return-1},i.prototype.uncompressToBuffer=function(i){for(var n,r,a,o,c=this.array,d=c.length,l=this.pos,h=0;l<c.length;)if(n=c[l],l+=1,3&n){switch(3&n){case 1:r=4+(n>>>2&7),o=c[l]+(n>>>5<<8),l+=1;break;case 2:if(l+1>=d)return!1;r=1+(n>>>2),o=c[l]+(c[l+1]<<8),l+=2;break;case 3:if(l+3>=d)return!1;r=1+(n>>>2),o=c[l]+(c[l+1]<<8)+(c[l+2]<<16)+(c[l+3]<<24),l+=4}if(0===o||o>h)return!1;s(i,h,o,r),h+=r}else{if((r=1+(n>>>2))>60){if(l+3>=d)return!1;a=r-60,r=1+((r=c[l]+(c[l+1]<<8)+(c[l+2]<<16)+(c[l+3]<<24))&e[a]),l+=a}if(l+r>d)return!1;t(c,l,i,h,r),l+=r,h+=r}return!0},H.SnappyDecompressor=i,H}var L,j,M={};var D,U=function(){if(j)return E;function e(){return"object"==typeof process&&"object"==typeof process.versions&&void 0!==process.versions.node}function t(t){return t instanceof Uint8Array&&(!e()||!Buffer.isBuffer(t))}function s(e){return e instanceof ArrayBuffer}function i(t){return!!e()&&Buffer.isBuffer(t)}j=1;var n=P().SnappyDecompressor,r=function(){if(L)return M;L=1;var e=new Array(15);function t(e,t){return 506832829*e>>>t}function s(e,t){return e[t]+(e[t+1]<<8)+(e[t+2]<<16)+(e[t+3]<<24)}function i(e,t,s){return e[t]===e[s]&&e[t+1]===e[s+1]&&e[t+2]===e[s+2]&&e[t+3]===e[s+3]}function n(e,t,s,i,n){return s<=60?(i[n]=s-1<<2,n+=1):s<256?(i[n]=240,i[n+1]=s-1,n+=2):(i[n]=244,i[n+1]=s-1&255,i[n+2]=s-1>>>8,n+=3),function(e,t,s,i,n){var r;for(r=0;r<n;r++)s[i+r]=e[t+r]}(e,t,i,n,s),n+s}function r(e,t,s,i){return i<12&&s<2048?(e[t]=1+(i-4<<2)+(s>>>8<<5),e[t+1]=255&s,t+2):(e[t]=2+(i-1<<2),e[t+1]=255&s,e[t+2]=s>>>8,t+3)}function a(e,t,s,i){for(;i>=68;)t=r(e,t,s,64),i-=64;return i>64&&(t=r(e,t,s,60),i-=60),r(e,t,s,i)}function o(r,o,c,d,l){for(var h=1;1<<h<=c&&h<=14;)h+=1;var u=32-(h-=1);void 0===e[h]&&(e[h]=new Uint16Array(1<<h));var p,_=e[h];for(p=0;p<_.length;p++)_[p]=0;var m,v,g,f,S,b,w,I,y,T,A=o+c,C=o,k=o,O=!0;if(c>=15)for(m=A-15,g=t(s(r,o+=1),u);O;){b=32,f=o;do{if(v=g,w=b>>>5,b+=1,f=(o=f)+w,o>m){O=!1;break}g=t(s(r,f),u),S=C+_[v],_[v]=o-C}while(!i(r,o,S));if(!O)break;l=n(r,k,o-k,d,l);do{for(I=o,y=4;o+y<A&&r[o+y]===r[S+y];)y+=1;if(o+=y,l=a(d,l,I-S,y),k=o,o>=m){O=!1;break}_[t(s(r,o-1),u)]=o-1-C,S=C+_[T=t(s(r,o),u)],_[T]=o-C}while(i(r,o,S));if(!O)break;g=t(s(r,o+=1),u)}return k<A&&(l=n(r,k,A-k,d,l)),l}function c(e){this.array=e}return c.prototype.maxCompressedLength=function(){var e=this.array.length;return 32+e+Math.floor(e/6)},c.prototype.compressToBuffer=function(e){var t,s=this.array,i=s.length,n=0,r=0;for(r=function(e,t,s){do{t[s]=127&e,(e>>>=7)>0&&(t[s]+=128),s+=1}while(e>0);return s}(i,e,r);n<i;)r=o(s,n,t=Math.min(i-n,65536),e,r),n+=t;return r},M.SnappyCompressor=c,M}().SnappyCompressor,a="Argument compressed must be type of ArrayBuffer, Buffer, or Uint8Array";return E.uncompress=function(e,r){if(!t(e)&&!s(e)&&!i(e))throw new TypeError(a);var o=!1,c=!1;t(e)?o=!0:s(e)&&(c=!0,e=new Uint8Array(e));var d,l,h=new n(e),u=h.readUncompressedLength();if(-1===u)throw new Error("Invalid Snappy bitstream");if(u>r)throw new Error(`The uncompressed length of ${u} is too big, expect at most ${r}`);if(o){if(d=new Uint8Array(u),!h.uncompressToBuffer(d))throw new Error("Invalid Snappy bitstream")}else if(c){if(d=new ArrayBuffer(u),l=new Uint8Array(d),!h.uncompressToBuffer(l))throw new Error("Invalid Snappy bitstream")}else if(d=Buffer.alloc(u),!h.uncompressToBuffer(d))throw new Error("Invalid Snappy bitstream");return d},E.compress=function(e){if(!t(e)&&!s(e)&&!i(e))throw new TypeError(a);var n=!1,o=!1;t(e)?n=!0:s(e)&&(o=!0,e=new Uint8Array(e));var c,d,l,h=new r(e),u=h.maxCompressedLength();if(n?(c=new Uint8Array(u),l=h.compressToBuffer(c)):o?(c=new ArrayBuffer(u),d=new Uint8Array(c),l=h.compressToBuffer(d)):(c=Buffer.alloc(u),l=h.compressToBuffer(c)),!c.slice){var p=new Uint8Array(Array.prototype.slice.call(c,0,l));if(n)return p;if(o)return p.buffer;throw new Error("Not implemented")}return c.slice(0,l)},E}();class z{constructor(e,t,s,i){this.configStore=i,this.logger=e,this.storage=t,this.store=s}overrideProperties(e){var t,s;const{propertiesOverride:i}=this.store.getState();return i?{events:e.events.reduce(((e,t)=>{const s=i(t.event_name,t,_);return Object.keys(s).length&&e.push(s),e}),[]),global:i(null!==(s=null===(t=e.events[0])||void 0===t?void 0:t.event_name)&&void 0!==s?s:"",e.global,_)}:e}setHeaders(e,s,i=!1){const{compression:n,useCustomLoggerApi:r}=this.configStore.getState(),a=this.store.getState(),{customHeaders:o,debugMode:d}=a,l=function(e,t){var s={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(s[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(i=Object.getOwnPropertySymbols(e);n<i.length;n++)t.indexOf(i[n])<0&&Object.prototype.propertyIsEnumerable.call(e,i[n])&&(s[i[n]]=e[i[n]])}return s}(a,["customHeaders","debugMode"]),h=o[c],u=this.storage.getLocalItem("visionSession"),p=t(u.session_id,m);r&&Object.entries(o).forEach((([t,s])=>e.setRequestHeader(t,s)));const _=(t,s)=>{const i=t.toLowerCase();r&&Object.keys(o).some((e=>e.toLowerCase()===i))||e.setRequestHeader(t,s)};d||"snappy"!==n||_("Content-Encoding","snappy"),h&&_(c,h),_("Accept","application/json"),_("App-Id",l.app_id),_("Content-Type","application/json"),_("Event-Count",String(s.length)),_("Session-Id",u.session_id),_("Suite",l.app_suite),_("Vision-Id",u.vision_id),r||(_("Authorization",p),_("Vauth",p)),i&&s.length&&"string"==typeof s[0].media_session_id&&(_("Event-Type",s[0].event_name),_("Media-Session-Id",s[0].media_session_id))}postEvents(e,t=!1,s=!0){const{customLoggerApiEndpoint:n,useCustomLoggerApi:r}=this.configStore.getState();if(!(e=this.overrideProperties(e)).events.length||r&&!/^https?:\/\//.test(n))return;const{customLoggerCallback:a,debugMode:o,flatPayload:c,url:d}=this.store.getState(),l=new XMLHttpRequest;l.onreadystatechange=()=>{if(4!==l.readyState)return;r&&a&&a({isRetry:!s,responseText:l.responseText,status:l.status,statusText:l.statusText,url:n});const i=l.status>=400&&l.status<=500;i&&s?this.postEvents(e,t,!1):i&&this.logger.log(l.statusText,"Error")},l.open("POST",r?n:`${d.replace(/\/+$/,"")}/${t?"media":"event"}`,!0),l.withCredentials=!0,this.setHeaders(l,e.events,t);const h=JSON.stringify(c?Object.assign(Object.assign({},e.global),e.events[0]):e);l.send(o||"snappy"!==this.configStore.getState().compression?h:new Blob([U.compress(i(h))],{type:"text/plain"}))}}class B{constructor(){var e;this._callQueue=[],this._eventBus=new v,this._isInitialized=!1,this._storage=new S,this._store=w(((e,t)=>({app_bundle_id:"",app_id:"",app_platform:"",app_suite:"",app_version:"",customHeaders:{},guestIds:[],lastHeartbeat:0,skipPrivacyValidation:!1,url:"",clearCustomHeaders(){const s=t().customHeaders[c];e({customHeaders:null!=s?{[c]:s}:{}})},deleteCustomHeader(s,i=!1){if(!i&&s===c)return;const n=Object.assign({},t().customHeaders);delete n[s],e({customHeaders:n})},setCustomHeader(s,i,n=!1){if(!(s=s.trim())||!n&&s.toLowerCase()===c.toLowerCase())return;const r="string"==typeof i?i.trim():JSON.stringify(i);if(""==r||null==i){const i=Object.assign({},t().customHeaders);return delete i[s],void e({customHeaders:i})}e({customHeaders:Object.assign(Object.assign({},t().customHeaders),{[s]:r})})},updateGuestIds(s,i){const n=["primary","secondary"].indexOf(i),r=t().guestIds.some((e=>e.id===s.id));if(-1===n&&r)return;const a=t().guestIds.map((e=>Object.assign({},e)));n>-1?a[n]=s:a.push(s),e({guestIds:a})}})));const{pollConfigIntervalSec:t}=u,s=new k(u,{fetchIntervalSec:t,sdk:"vision"}),i=new g(this._store),n=new z(i,this._storage,this._store,s.store);return this._configurator=s,this._logger=i,this._sessionService=new f(this._eventBus,this._storage,this._store,s.store),this._trackingService=new A(this._eventBus,this._storage,this._store,n,s.store),this.constructor._instance=null!==(e=this.constructor._instance)&&void 0!==e?e:this,this.constructor._instance}static _createAdder(e){return this._wrap((function(t,s){const i=this.getInstance(),n=i._storage.getSessionItem(e)||[];n.some((e=>e.id===t))||i._storage.setSessionItem(e,[...n,{id:t,source:s}])}))}static _createSetter(e){return this._wrap((function(t){this.getInstance()._storage.setSessionItem(e,t)}))}static _createUnsetter(e,t){return this._wrap((function(s){const i=this.getInstance(),n=i._storage.getSessionItem(e)||[],r=n.filter((e=>e[t]!==s));n.length!==r.length&&i._storage.setSessionItem(e,r)}))}static _createUnsetterAll(e){return this._wrap((function(){this.getInstance()._storage.removeSessionItem(e)}))}static _convertConsentToCollection(e){return e.replace(/^consent=/,"categories=")}static getInstance(){var e;return null!==(e=this._instance)&&void 0!==e?e:new this}static setConfigs(t){if("object"!=typeof t||null==t||!t.app_id||!t.app_suite||!t.url)return void console.error(new TypeError("VISION: config argument is invalid"));const s=this.getInstance();s._configurator.settings.debug=!!t.debugMode,s._configurator.settings.url=`${t.url.replace(/\/+$/,"")}/config/${t.app_id}`,s._store.setState(t),s._isInitialized||(s._storage.setSessionItem("visionPagePreviousUrl",window.document.referrer||"na"),s._storage.setSessionItem("visionPageInstanceId",e()),s._sessionService.run(),s._configurator.fetchConfig(),s._trackingService.run(),s._callQueue.splice(0,s._callQueue.length).forEach((e=>e())),s._isInitialized=!0)}static setForceDisableCollection(){this.getInstance()._storage.setLocalItem("visionForceDisableCollection",!0)}static unsetForceDisableCollection(){const e=this.getInstance();e._storage.getLocalItem("visionForceDisableCollection")&&(e._storage.removeLocalItem("visionForceDisableCollection"),e._eventBus.publish("client.unset-force-disable-collection"))}static _wrap(e){return function(...t){const s=this.getInstance();s._isInitialized?e.call(this,...t):s._callQueue.push((()=>e.call(this,...t)))}}}D=B,B.addDssId=D._createAdder("visionUserDssId"),B.addGuestId=D._wrap((function(e,t,s,i){this.getInstance()._store.getState().updateGuestIds({id:e,registered:!!s,source:t},i)})),B.addSubscriptionId=D._wrap((function(e,t){const s=this.getInstance(),i="visionUserSubscriptionId",n=s._storage.getSessionItem(i)||[],[r,a]=null!=t?[t,e]:[e];n.some((e=>e.id===a&&e.source===r))||s._storage.setSessionItem(i,[...n,{id:a,source:r}])})),B.addTest=D._createAdder("visionStateTest"),B.clearHeaders=D._wrap((function(){this.getInstance()._store.getState().clearCustomHeaders()})),B.deleteConsentHeader=D._wrap((function(){this.getInstance()._store.getState().deleteCustomHeader(c,!0)})),B.deleteCollectionHeader=D._wrap((function(){this.getInstance()._store.getState().deleteCustomHeader(c,!0)})),B.deleteHeader=D._wrap((function(e){this.getInstance()._store.getState().deleteCustomHeader(e)})),B.removeCustomLoggerCallback=D._wrap((function(){this.getInstance()._store.setState({customLoggerCallback:void 0})})),B.removePropertiesOverride=D._wrap((function(){this.getInstance()._store.setState({propertiesOverride:void 0})})),B.setAccessMethod=D._createSetter("visionUserAccessMethod"),B.setAdvertiserId=D._createSetter("visionDeviceAdvertiserId"),B.setAffiliate=D._createSetter("visionUserAffiliate"),B.setConsentHeader=D._wrap((function(e){if("string"!=typeof e)return void this.getInstance()._logger.log("setConsentHeader value argument is invalid","Error");const t=this._convertConsentToCollection(e);this.getInstance()._store.getState().setCustomHeader(c,t,!0)})),B.setCollectionHeader=D._wrap((function(e){"string"==typeof e?this.getInstance()._store.getState().setCustomHeader(c,e,!0):this.getInstance()._logger.log("setCollectionHeader value argument is invalid","Error")})),B.setCustomLoggerCallback=D._wrap((function(e){"function"==typeof e?this.getInstance()._store.setState({customLoggerCallback:e}):this.getInstance()._logger.log("setCustomLoggerCallback callback argument is invalid","Error")})),B.setDisneyPlusBundle=D._createSetter("visionUserDisneyPlusBundle"),B.setEventProperties=D._createSetter("visionCustomEventProperties"),B.setGlobalProperties=D._createSetter("visionCustomGlobalProperties"),B.setHeader=D._wrap((function(e,t){"string"==typeof e?this.getInstance()._store.getState().setCustomHeader(e,t):this.getInstance()._logger.log("setHeader key argument is invalid","Error")})),B.setMvpdName=D._createSetter("visionUserMvpdName"),B.setMvpdShortName=D._createSetter("visionUserMvpdShortName"),B.setPrivacy=D._createSetter("visionStatePrivacy"),B.setPropertiesOverride=D._wrap((function(e){if("function"!=typeof e)throw new TypeError("VISION: propertiesOverride callback argument is invalid");this.getInstance()._store.setState({propertiesOverride:e})})),B.setSubscriberType=D._createSetter("visionUserSubscriberType"),B.unsetAccessMethod=D._createUnsetterAll("visionUserAccessMethod"),B.unsetAdvertiserId=D._createUnsetterAll("visionDeviceAdvertiserId"),B.unsetAffiliate=D._createUnsetterAll("visionUserAffiliate"),B.unsetAllDssId=D._createUnsetterAll("visionUserDssId"),B.unsetAllSubscriptionId=D._createUnsetterAll("visionUserSubscriptionId"),B.unsetAllTest=D._createUnsetterAll("visionStateTest"),B.unsetDisneyPlusBundle=D._createUnsetterAll("visionUserDisneyPlusBundle"),B.unsetDssId=D._createUnsetter("visionUserDssId","id"),B.unsetMvpdName=D._createUnsetterAll("visionUserMvpdName"),B.unsetMvpdShortName=D._createUnsetterAll("visionUserMvpdShortName"),B.unsetPrivacy=D._createUnsetterAll("visionStatePrivacy"),B.unsetEventProperties=D._createUnsetterAll("visionCustomEventProperties"),B.unsetGlobalProperties=D._createUnsetterAll("visionCustomGlobalProperties"),B.unsetSubscriberType=D._createUnsetterAll("visionUserSubscriberType"),B.unsetSubscriptionId=D._createUnsetter("visionUserSubscriptionId","source"),B.unsetTest=D._createUnsetter("visionStateTest","id"),"undefined"!=typeof window&&(window.VisionConfigurator=k);class x extends B{constructor(){super(...arguments),this._mediaInstances=[],this.track=x._wrap((e=>{if(e=Array.isArray(e)?e:[e],t=e,!Array.isArray(t)||!t.every(r))return void this._logger.log("Missing property event_name. Event not sent","Error");var t;this._trackingService.handleEvents(e);const[s]=e.filter((({event_name:e})=>e.startsWith("media_")));if(!s)return;const i=this._mediaInstances.reduce(((e,{id:t},i)=>-1===e&&t===s.media_id?i:e),-1);if(i>-1){const{instance:e}=this._mediaInstances[i];e.handleEvent(s),"media_stop"===s.event_name&&this._mediaInstances.splice(i,1)}else if(["media_ad_start","media_start"].indexOf(s.event_name)>-1){const e=new n((e=>this._trackingService.postMedia(e)),this._configurator.store);this._mediaInstances.push({id:s.media_id,instance:e}),e.handleEvent(s)}})).bind(x)}}return x}));
